extends layouts/default

// Templates
block templates
    include templates

block main
    include templates/tpl_loading

block footer
    include includes/footer

block loaderscript
    script(type='text/javascript').
        requirejs.config({
            paths: {
                yepnope: '/js/libraries/yepnope-1.5.4',
                jquery: ['//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min', '/js/libraries/jquery-2.0.3.min'],
                jqueryui: '/js/libraries/jquery-ui-1.10.3.custom.min',
                underscore: '/js/libraries/underscore-1.5.2.min',
                backbone: '/js/libraries/backbone-1.1.0.min',
                main: '/js/main',
                router: '/js/router',
                bootstrap: '/js/libraries/bootstrap-3.0.2.min',
                marionette: '/js/libraries/backbone-marionette-1.4.0.min',
                moment: '/js/libraries/moment-with-langs-2.4.0.min',
                lib: '/js/libraries/lib',
                BB: '/js/libraries/backbone-helper',
                dust: '/js/libraries/dust-all-helpers',
                'dust-lib': '/js/libraries/dust-full-2.2.0'
            },
            shim: {
                'backbone': {
                    deps: ['underscore', 'jquery'],
                    exports: 'Backbone'
                },
                'dust': {
                    deps: ['dust-lib'],
                    exports: 'dust'
                },
                'jqueryui': ['jquery'],
                'bootstrap': ['jquery'],
                'router': ['backbone','main'],
                'BB': ['backbone'],
                'marionette': {
                    deps: ['backbone'],
                    exports: 'Marionette'
                },
                'main': ['BB'],
                'underscore': {
                    exports: '_'
                }
            }
        });


        (function (window, document) {
            "use strict";

            requirejs(['jquery','yepnope', 'dust', 'main', 'router'], function($, yepnope, dust, WRCON, router){
                var count = 1;
                var $bar = $('#progress-bar-inner');
                var load_files = [
                    // Models
                    #{models}
                    // Views
                    #{views}
                    // CSS
                    '/css/ui-lightness/jquery-ui-1.10.3.custom.min.css',
                    '/css/font-awesome.min.css'
                ];
                var increment = 100 / load_files.length;

                window.yepnope({
                    load: load_files,
                    callback: function(){
                        $bar.stop().animate({width: ((increment * count) + '%')});
                        count++;
                    },
                    complete: function(){
                        // Build the templates, and then remove the script tags from the DOM
                        var elements = document.getElementsByClassName('dust-template');
                        var len = elements.length;
                        while(len--){
                            var element = elements.item(0);
                            dust.loadSource(dust.compile(element.text, element.id));
                            document.getElementById(element.id).parentNode.removeChild(element);
                        }

                        window.setTimeout(function(){
                            $('#loading').slideUp(function(){
                                $(this).remove();
                                WRCON.init(router);
                            });
                        },1000);
                    }
                });
            });
        })(window,document);